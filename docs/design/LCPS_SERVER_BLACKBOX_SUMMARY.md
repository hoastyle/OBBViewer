# LCPS 黑匣子调试系统设计概要

**文档版本**: 1.0
**创建日期**: 2025-12-25
**状态**: 设计完成
**完整文档索引**: [LCPS黑匣子文档索引](LCPS_BLACKBOX_INDEX.md)

---

## 📋 执行摘要

本文档概述LCPS黑匣子调试系统的核心设计理念、架构和实施路线图。

**设计理念**: 类比航空黑匣子（FDR）+ 汽车EDR

**核心目标**:
- ✅ 自动录制异常前后完整数据（30秒前 + 10秒后）
- ✅ 智能异常检测，零配置自动触发
- ✅ 决策过程透明化，支持可解释分析
- ✅ 非侵入性设计，不影响LCPS主功能

**关键指标**:
- 开发周期：8-11周
- 团队规模：1-2人
- 性能开销：常态CPU <2%, 内存 ~450MB
- ROI：调试效率提升10倍+

---

## 🏗️ 系统架构

### 4层架构设计

```
┌────────────────────────────────────────────────────────────┐
│              黑匣子录制系统（独立线程）                     │
│  ┌──────────────────────────────────────────────────┐     │
│  │  Layer 1: 环形缓冲区管理                         │     │
│  │  - CircularBuffer<Frame> (30秒数据)             │     │
│  │  - 持续写入最新数据，覆盖最旧数据                 │     │
│  └──────────────────────────────────────────────────┘     │
│  ┌──────────────────────────────────────────────────┐     │
│  │  Layer 2: 异常检测引擎                           │     │
│  │  - 硬异常：碰撞、紧急停车、传感器故障            │     │
│  │  - 软异常：性能下降、决策抖动、延迟增加          │     │
│  │  - 预测异常：接近碰撞、频繁减速                  │     │
│  └──────────────────────────────────────────────────┘     │
│  ┌──────────────────────────────────────────────────┐     │
│  │  Layer 3: 异步数据持久化                         │     │
│  │  - 异常触发：保存缓冲区 + 后续10秒数据           │     │
│  │  - HDF5格式：统一存储，时间戳索引                │     │
│  │  - 压缩策略：zstd level 6 (~74%压缩率)          │     │
│  └──────────────────────────────────────────────────┘     │
│  ┌──────────────────────────────────────────────────┐     │
│  │  Layer 4: 自动化报告生成                         │     │
│  │  - 异常概要、时间线分析、性能分析                │     │
│  │  - Markdown报告 + 图表                          │     │
│  └──────────────────────────────────────────────────┘     │
└────────────────────────────────────────────────────────────┘
```

---

## 💡 8个创新功能

### 1. 环形缓冲 + 异常前后录制

**核心机制**:
- 持续录制最近30秒数据到环形缓冲
- 异常触发：保存缓冲区（异常前30s）+ 继续录制10s（异常后）
- 总计：40秒完整数据

**内存占用**: 900帧 × ~500KB/帧 = ~450MB

---

### 2. 智能异常检测引擎

**8类异常自动检测**:

| 异常类型 | 检测方式 | 严重性 |
|---------|---------|--------|
| 碰撞发生 | `curStatus == STOP` | 🔴 Critical |
| 传感器故障 | `pointcloud.empty() > 3帧` | 🔴 Critical |
| 紧急停车 | `SAFE → STOP`（跳过SLOW） | 🔴 Critical |
| 性能下降 | `fps < 20Hz`（连续5秒） | 🟡 Warning |
| 决策抖动 | `SAFE ↔ SLOW` (频率>5次/秒) | 🟡 Warning |
| 延迟增加 | `frame_time > 100ms` | 🟡 Warning |
| 接近碰撞 | `min_distance < 3.0m` | 🟢 Info |
| 频繁减速 | `SLOW次数 > 10次/分钟` | 🟢 Info |

---

### 3. 分层数据录制策略

**3层数据结构**:

| 层级 | 数据内容 | 触发条件 | 存储速率 |
|------|---------|---------|---------|
| **Layer 1** | OBB、决策、位置、状态 | 始终录制 | ~150KB/s |
| **Layer 2** | 完整点云、传感器数据、决策路径 | 异常时 | ~15MB/s |
| **Layer 3** | 性能指标、日志、图像 | 调试模式 | ~3MB/s |

---

### 4. 决策过程回溯

**记录内容**:
- 每个决策节点的输入参数
- 中间计算结果
- 决策分支选择原因
- 置信度评分

**输出示例**:
```
ObstacleDetection (95%)
  Input: pointcloud_size=98532, obb_count=3
  Output: min_distance=2.8m
  ↓
CollisionPrediction (88%)
  Input: speed=0.5m/s, distance=2.8m
  Output: collision_time=5.6s
  ↓
SafetyDecision (100%)
  Input: distance=2.8m, threshold=3.5m
  Output: decision=SLOW
  Reason: "Distance < SLOW threshold"
```

---

### 5. 嵌入式性能监控

**监控指标**:
- 时间：frame_time, obb_detection_ms, collision_check_ms, decision_time_ms
- 频率：fps, dropped_frames
- 资源：memory_usage_mb, cpu_usage_percent
- 数据：pointcloud_size, obb_count

**实现**: RAII计时器，开销<1%

---

### 6. 智能存储管理

**策略**:
1. 自动清理：保留最近7天 + 所有异常
2. 存储配额：最大50GB，达到80%警告，95%停止Layer 2+3
3. 分级压缩：Layer 1低压缩，Layer 2中压缩，Layer 3高压缩

---

### 7. 实时流+离线录制双模式

**模式1**: 本地录制（数据保存到HDF5文件）
**模式2**: 实时流（通过ZMQ发布到OBBViewer工具）

**优势**: 开发时实时观测，生产环境录制回放

---

### 8. 自动化异常报告生成

**报告内容**:
- 异常概要（时间、类型、严重性）
- 时间线分析（异常前后事件序列）
- 决策路径可视化
- 性能分析（CPU/内存/帧率曲线）
- 相关数据文件索引
- 根因分析和改进建议

**格式**: Markdown + 嵌入图表

---

## 📅 实施路线图

### Phase 1: 核心黑匣子功能（3-4周，P0）

**Week 1-2**:
- [ ] BlackBoxRecorder类（环形缓冲管理）
- [ ] Frame数据结构（分层数据）
- [ ] 硬异常检测（碰撞、传感器故障、紧急停车）
- [ ] 异常触发录制（前30秒+后10秒）

**Week 3-4**:
- [ ] HDF5写入（分层存储，压缩）
- [ ] 时间戳索引
- [ ] 基础异常报告生成
- [ ] 存储管理（自动清理）

**验收标准**:
- 环形缓冲正常运行，内存<500MB
- 碰撞时自动触发录制
- HDF5文件包含完整40秒数据
- 主逻辑性能开销<2%

---

### Phase 2: 高级功能（3-4周，P1）

**Week 5-6**:
- [ ] DecisionTrace数据结构
- [ ] 集成到collisionCheck函数
- [ ] 决策路径可视化

**Week 7-8**:
- [ ] PerformanceMetrics收集
- [ ] 软异常检测
- [ ] 性能数据集成到报告

**验收标准**:
- 决策路径完整记录
- 性能异常自动检测
- 报告包含决策路径和性能曲线

---

### Phase 3: 智能优化（2-3周，P2）

**Week 9-10**:
- [ ] 预测异常检测
- [ ] 自适应采样
- [ ] 智能存储配额管理

**Week 11**:
- [ ] 与OBBViewer工具集成
- [ ] 双模式运行（实时流+离线录制）

**验收标准**:
- 预测异常检测率>80%
- 存储自动管理，不崩溃
- OBBViewer可回放黑匣子数据

---

## 📊 成本效益分析

### 开发成本

- **工作量**: 8-11周
- **团队**: 1-2人
- **技术栈**: C++17, HDF5, ZMQ, Boost

### 性能开销

| 指标 | 常态运行 | 异常录制 |
|------|---------|---------|
| **CPU** | <2% | <5% |
| **内存** | ~450MB | ~500MB |
| **磁盘** | ~540MB/小时 | ~65GB/小时 |

### 收益评估

| 收益类型 | 提升幅度 | 价值 |
|---------|---------|------|
| 调试效率 | 数小时→数分钟 | ⭐⭐⭐⭐⭐ |
| 故障重现 | 30%→95% | ⭐⭐⭐⭐⭐ |
| 根因分析 | 50%→90% | ⭐⭐⭐⭐ |
| 系统可靠性 | 未知故障-50% | ⭐⭐⭐⭐ |

**ROI**: 投入8-11周，长期收益显著（调试效率提升10倍+）

---

## 🎯 关键决策

### ADR-011: 黑匣子环形缓冲架构

**决策**: 使用boost::circular_buffer实现30秒环形缓冲

**理由**:
- ✅ O(1)写入性能
- ✅ 自动覆盖最旧数据，无需手动管理
- ✅ 固定内存占用（~450MB）

**替代方案**: std::deque（需手动管理大小）

---

### ADR-012: 异常检测触发策略

**决策**: 8类异常分层检测（硬异常、软异常、预测异常）

**理由**:
- ✅ 覆盖所有关键异常场景
- ✅ 分层严重性便于优先级处理
- ✅ 低误报率（基于统计学习）

**替代方案**: 仅硬异常检测（覆盖不全）

---

## 📚 相关文档

- [LCPS调试功能评估报告](LCPS_DEBUG_EVALUATION.md) - 当前问题分析
- [LCPS适配性改动分析](LCPS_ADAPTATION_ANALYSIS.md) - 代码适配方案
- [LCPS黑匣子文档索引](LCPS_BLACKBOX_INDEX.md) - 完整文档导航

---

## ✅ 下一步行动

```bash
# 1. 更新项目规划
/wf_01_planning "添加LCPS黑匣子系统到PLANNING.md"

# 2. 创建任务清单
/wf_02_task update "创建Phase 1-3任务"

# 3. 开始实施
/wf_05_code "实现BlackBoxRecorder核心类"
```

---

**文档创建**: 2025-12-25
**状态**: 设计阶段完成
**下一阶段**: 实施Phase 1（核心黑匣子功能）
